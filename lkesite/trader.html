<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>The Last Kingdom: Eclipse</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="assets/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }

      @media (max-width: 980px) {
        /* Enable use of floated navbar text */
        .navbar-text.pull-right {
          float: none;
          padding-left: 5px;
          padding-right: 5px;
        }
      }
    </style>
    <link href="assets/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="assets/css/trader.css" rel="stylesheet">
	<link rel="stylesheet" href="assets/css/jquery-ui.css">
	
<script src="assets/js/jquery-1.9.1.min.js"></script>
<script src="assets/js/jquery-ui.js"></script>
<!--<script src="assets/js/kathread.js"></script> -->
 <script>
$(function() {
$( "#tabs" ).tabs();
});
</script>

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="assets/js/html5shiv.js"></script>
    <![endif]-->

<!-- This goes in the document HEAD so IE7 and IE8 don't cry -->
	<!--[if lt IE 9]>
	<style type="text/css">
		table.gradienttable th {
			filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#d5e3e4', endColorstr='#b3c8cc',GradientType=0 );
			position: relative;
			z-index: -1;
		}
		table.gradienttable td {
			filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ebecda', endColorstr='#ceceb7',GradientType=0 );
			position: relative;
			z-index: -1;
		}
	</style>
	<![endif]-->

<style type="text/css">
table.imagetable {
	font-family: verdana,arial,sans-serif;
	font-size:11px;
	color:#333333;
	border-width: 1px;
	border-color: #999999;
	border-collapse: collapse;
}
table.imagetable th {
	background:#b5cfd2 url('assets/img/cell-blue.jpg');
	border-width: 1px;
	padding: 8px;
	border-style: solid;
	border-color: #999999;
}
.tablenormal {
	background:#dcddc0 url('assets/img/cell-grey.jpg');
	border-width: 1px;
	padding: 8px;
	border-style: solid;
	border-color: #999999;
}
.tableselected {
	background:#b5cfd2 url('assets/img/cell-yellow.jpg');
	border-width: 1px;
	padding: 8px;
	border-style: solid;
	border-color: #999999;
}
td {
  text-align: center;
  vertical-align: middle;
}
img {
    height: auto;
    max-width: 100%;
    padding: 5px;
    vertical-align: middle;
}
select, textarea, input[type="text"], input[type="password"], input[type="datetime"], input[type="datetime-local"], input[type="date"], input[type="month"], input[type="time"], input[type="week"], input[type="number"], input[type="email"], input[type="url"], input[type="search"], input[type="tel"], input[type="color"], .uneditable-input {
    border-radius: 4px 4px 4px 4px;
    color: #555555;
    display: inline-block;
    font-size: 14px;
    height: 20px;
    line-height: 10px;
    margin-bottom: 5px;
    margin-top: 5px;
    padding: 3px 6px;
    vertical-align: middle;
}

</style>
	
    <!-- Fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/ico/apple-touch-icon-114-precomposed.png">
      <link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/ico/apple-touch-icon-72-precomposed.png">
                    <link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png">
                                   <link rel="shortcut icon" href="assets/ico/favicon.png">
  </head>

  <body>

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="brand" href="#">LKE</a>
          <div class="nav-collapse collapse">
            <p class="navbar-text pull-right">
             <!-- Logged in as <a href="#" class="navbar-link">Username</a> -->
            </p>
            <ul class="nav">
              <li class="active"><a href="index.html">Home</a></li>
              <li><a href="#forum">Forum</a></li>
              <li><a href="http://lkwiki.kingdomofk.net/">Wiki</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span3">
          <div class="well sidebar-nav">
            <ul class="nav nav-list">
              <li class="nav-header">Info</li>
              <li><a href="htconnect.html">How to connect</a></li>
              <li><a href="commands.html">Commands</a></li>
              <li><a href="refining.html">Refining</a></li>
              <li class="active"><a href="trader.html"><img src="assets/img/item/43.jpg" style="height:23px;padding:0px;"></img> Trader</a></li>
              <li><a href="beginner.html">Beginner Guide</a></li>
              <li><a href="donate.html">Donate</a></li>
            </ul>
          </div><!--/.well -->
        </div><!--/span-->
        <div class="span9">
		
<div id="tabs">
<ul>
<li><a href="#tabs-1">Login</a>
<p>
      


</p>
</li>
<li><a href="#tabs-2" style="display: none">Sell</a></li>
<li><a href="#tabs-3" style="display: none">Buy</a></li>
<li><a href="#tabs-5" style="display: none">Active</a></li>
<li><a href="#tabs-4" style="display: none">Claim</a></li>
<li id="refresh"></li>
<li id="charName"></li>
<li id="charGold"></li>
<li id="charAGold"></li>
</ul>
<div id="tabs-1">
<p></p>
</div>
<div id="tabs-2">
<p></p>
</div>
<div id="tabs-3">
<p></p>
</div>
<div id="tabs-5">
<p></p>
</div>
<div id="tabs-4">
<p></p>
</div>
</div>
		
		     <div class="row-fluid" id="loginFul"> 
            <div class="span4">
              <form id="login"> 
				<h1>Trader</h1>
				<div id="logindiv"> 
					<fieldset id="inputs">
						<input id="username" type="text" placeholder="Username" autofocus="autofocus" required="required">   
						<input id="password" type="password" placeholder="Password" required="required">
					</fieldset>
					<fieldset id="actions">
						<input type="button" id="submitLogin" value="Log in"></button>
						<a>Use your game User/Pass</a>
					</fieldset>
					<div id="panel">
						<div id="er_message"></div>
					</div>
			</div>
			 </form> 
             <!-- <p><a class="btn" href="#">View details &raquo;</a></p> -->
            </div><!--/span-->
          </div> <!--/row-->

      </div><!--/row-->

      <hr>



    </div><!--/.fluid-container-->
      <footer>
        <p>&copy; The Last Kingdom: Eclipse (1998) - 2013</p>
      </footer>

<script src="assets/js/ByteBuffer.js-master/ByteBuffer.min.js"></script>
<script src="assets/js/ProtoBuf.js-master/ProtoBuf.min.js"></script>
<script src="assets/js/CryptoJS/rollups/sha256.js"></script>

<script>

$('#password').bind('keypress',function (event){
  if (event.keyCode === 13){
    $('#submitLogin').trigger('click');
  }
});

var socket;

var ProtoBuf = dcodeIO.ProtoBuf;
var builder = ProtoBuf.protoFromFile("assets/proto/webtrader.proto");
var ProtoC = builder.build();

function connectWebsocket() {
	
	  //  socket = new WebSocket('ws://198.245.61.145:43332/webtrader');
	    socket = new WebSocket('ws://localhost:43332/webtrader');
		socket.binaryType = "arraybuffer";
        socket.onopen = function() {
        //    alert('handshake successfully established. May send data now...');
		//	socket.send("Here's some text that the server is urgently awaiting!");
        };
        socket.onclose = function() {
			socket.close();
        //    alert('connection closed');
        };
		socket.onmessage = function(msg) {
			var YourMessage = builder.build("LoginProto");
			var tes = YourMessage.decode(msg.data);
			HandleMessage(tes);
		}
}
charclas = "16";
firstload = true;
var myHelloWorker;

function startKeepAlive()
{
	myHelloWorker = new Worker('assets/js/kathread.js');
	
	    myHelloWorker.addEventListener("message", function (event) 
		{
         if (event.data == "ping")
		 {
			ping();
		 }
        }, false);
	
	myHelloWorker.postMessage("start");
}

function ping()
{
			var loginproto = new ProtoC.LoginProto();
			loginproto.KeepAliveP = new ProtoC.KeepAlive();
			loginproto.KeepAliveP.result = "1";
			var buffer = loginproto.encode();
			socket.send(buffer.toArrayBuffer());
}

function HandleMessage(msg) {
	if (msg.LoginResponseP != null)
	{
		if (msg.LoginResponseP.loginresp == 1)// success
		{
			document.getElementById('er_message').innerHTML = "Success";
			charclas = msg.LoginResponseP.classtype;
			startKeepAlive();
			var loginproto = new ProtoC.LoginProto();
			loginproto.CharCurrencyP = new ProtoC.CharCurrency();
			var buffer = loginproto.encode();
			socket.send(buffer.toArrayBuffer());
		}
		if (msg.LoginResponseP.loginresp == 2) //wrongpass
		{
			document.getElementById('er_message').innerHTML = "Wrong Username or Password";
		}
		if (msg.LoginResponseP.loginresp == 3) //already online
		{
			document.getElementById('er_message').innerHTML = "You are already online";
		}
	}
	
	if (msg.CharCurrencyResponseP != null)
	{
		if (firstload)
		{
			document.getElementById('loginFul').innerHTML = null;
			
		//	document.getElementById('tabMenu').innerHTML =
			$('#ui-id-1').hide();
			$('#ui-id-2').show();
			$('#ui-id-3').show();
			$('#ui-id-4').show();
			$('#ui-id-5').show();
		}
		
		var classimg = "assets/img/class/knight.png";
		if (charclas == "1")
			classimg = "assets/img/class/knight.png";
		if (charclas == "2")
			classimg = "assets/img/class/swordsman.png";
		if (charclas == "4")
			classimg = "assets/img/class/wizard.png";
		if (charclas == "4")
			classimg = "assets/img/class/shaman.png";
			
		$('#charName').html("<img src="+classimg+" style=\"height:31px\"></img> "+userN);
		$('#charGold').html("<img src=\"assets/img/item/43.jpg\"></img> "+msg.CharCurrencyResponseP.Gold.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
		
		$('#charAGold').html("<img src=\"assets/img/item/54.jpg\"></img> " + 
		(msg.CharCurrencyResponseP.AGold == null ? "0" : msg.CharCurrencyResponseP.AGold.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")));
		
	//	$('#charGold').digits();
		$('#refresh').html("<img src=\"assets/img/refresh.png\"/ width=\"40\" height=\"40\" onclick='refreshTrader()'>");
		/*document.getElementById('tabs-1').innerHTML = 
			"<table width:100% id=\"charTable\">"+
			"<tr><td>Name: "+userN+"</td></tr>"+
			"<tr><td>Gold: "+ msg.CharCurrencyResponseP.Gold +"</td></tr>"+
			"<tr><td>AGold: "+ msg.CharCurrencyResponseP.AGold +"</td></tr>"+
			"</table>"+
			"<br>"
		
		;*/
		
		var loginproto = new ProtoC.LoginProto();
		loginproto.GetItemsP = new ProtoC.GetItems();
		var buffer = loginproto.encode();
		socket.send(buffer.toArrayBuffer());
		
		var loginproto = new ProtoC.LoginProto();
		loginproto.GetAuctionsP = new ProtoC.GetAuctions();
		var buffer = loginproto.encode();
		socket.send(buffer.toArrayBuffer());
	}
	
	if (msg.GetItemsResponseP != null)
	{
	    var tbstring = "";
		for (var i=0;i<msg.GetItemsResponseP.traderItem.length;i++)
		{
			var item = msg.GetItemsResponseP.traderItem[i];
			tbstring += 
			//background:#dcddc0 url('cell-grey.jpg'); 
			//onmouseover="this.style.backgroundColor='#ffff66';" onmouseout="this.style.backgroundColor='#d4e3e5';">
			"<tr class=\"tablenormal\" onmouseover=\"this.className=\'tableselected\'\" onmouseout=\"this.className=\'tablenormal\'\">"+
			"<input value='"+item.Serial+"' type='hidden'/>"+  //style="display: none"
			"<td><div style=\"float:left\"><img src=\"assets/img/item/"+item.Sprite+".jpg\"/></div>"+item.Name+"</td>"+
			"<td><input name='inputPrice_"+item.Serial+"' id='inputPrice_"+item.Serial+"' type='text' value='Sell Price' onfocus=\"if(this.value==\'Sell Price\')this.value=\'\'\"/></td>"+
			"<td><input name='sellItem' id='sellItem_"+item.Serial+"' type='button' value='Sell' onclick='sellButtonPressed("+item.Serial+")'/></td>"+
			"</tr>"
			;
		}
			 
	    document.getElementById('tabs-2').innerHTML =
		"<p>"+
			"<table width:100% class=\"imagetable\" id=\"itemTable\">"+
			"<tr><th>Name</th><th>Price</th><th>Action</th></tr>"+
			tbstring+
			"</table>"+
		"</p>"
		;
		if (firstload)
		{
		$('#ui-id-2').click();
		firstload = false;
		}
	}
	
	if (msg.GetAuctionsResponseP != null)
	{
	    var tbstring = "";
		var tbstringclaim = "";
		var tbstringactive = "";
		var countClaim = 0;
		var countActive = 0;
		for (var i=0;i<msg.GetAuctionsResponseP.auctiontraderItem.length;i++)
		{
			var item = msg.GetAuctionsResponseP.auctiontraderItem[i];
			if (item.flags == "2")
			{
				countClaim++;
				tbstringclaim += 
				"<tr class=\"tablenormal\" onmouseover=\"this.className=\'tableselected\'\" onmouseout=\"this.className=\'tablenormal\'\">"+
				"<input value='"+item.BItem.Serial+"' type='hidden'/>"+
				"<td><div style=\"float:left\"><img src=\"assets/img/item/"+item.BItem.Sprite+".jpg\"/></div>"+item.BItem.Name+"</td>"+
				"<td>"+item.Gold.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")+"</td>"+
				"<td><input name='claimItem' id='claimItem_"+item.BItem.Serial+"' type='button' value='Claim' onclick='claimButtonPressed("+item.BItem.Serial+")'/></td>"+
				"</tr>"
				;
			}
			else if (item.flags == "1")
			{
		//		if (tbstring.indexOf(item.BItem.Name) != -1)
								
				tbstring += 
				"<tr class=\"tablenormal\" onmouseover=\"this.className=\'tableselected\'\" onmouseout=\"this.className=\'tablenormal\'\">"+
				"<input value='"+item.BItem.Serial+"' type='hidden'/>"+
				"<td><div style=\"float:left\"><img src=\"assets/img/item/"+item.BItem.Sprite+".jpg\"/></div>"+item.BItem.Name+"</td>"+
			//	"<td>"+item.BItem.Stage+"</td>"+
				"<td>"+item.Gold.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")+"</td>"+
				"<td><input name='buyItem' id='buyItem_"+item.BItem.Serial+"' type='button' value='Buy' onclick='buyButtonPressed("+item.BItem.Serial+")'/></td>"+
				"<td>"+item.count+"</td>"+
				"</tr>"
				;
			}
			else if (item.flags == "3")
			{			
				countActive++;
				tbstringactive += 
				"<tr class=\"tablenormal\" onmouseover=\"this.className=\'tableselected\'\" onmouseout=\"this.className=\'tablenormal\'\">"+
				"<input value='"+item.BItem.Serial+"' type='hidden'/>"+
				"<td><div style=\"float:left\"><img src=\"assets/img/item/"+item.BItem.Sprite+".jpg\"/></div>"+item.BItem.Name+"</td>"+
			//	"<td>"+item.BItem.Stage+"</td>"+
				"<td>"+item.Gold.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")+"</td>"+
				"<td><input name='cancelItem' id='cancelItem_"+item.BItem.Serial+"' type='button' value='Cancel' onclick='claimButtonPressed("+item.BItem.Serial+")'/></td>"+
				"</tr>"
				;
			}
		}
		
		var ttttt = document.getElementById('ui-id-5');
		
		var claimnum = "Claim"
		if (countClaim > 0)
			claimnum += " ("+countClaim+")";
		document.getElementById('ui-id-5').innerHTML = claimnum;
		
		var actcount = "Active"
		if (countActive > 0)
			actcount += " ("+countActive+")";
		document.getElementById('ui-id-4').innerHTML = actcount;
		
	    document.getElementById('tabs-3').innerHTML =
		"<p>"+
			"<table width:100% class=\"imagetable\" id=\"auctionTable\">"+
			"<tr><th>Name</th><th>Price</th><th>Action</th><th>Count</th></tr>"+
			tbstring+
			"</table>"+
		"</p>"
		;
		    document.getElementById('tabs-4').innerHTML =
		"<p>"+
			"<table width:100% class=\"imagetable\" id=\"auctionTable\">"+
			"<tr><th>Name</th><th>Price</th><th>Action</th></tr>"+
			tbstringclaim+
			"</table>"+
		"</p>"
		;
		
		    document.getElementById('tabs-5').innerHTML =
		"<p>"+
			"<table width:100% class=\"imagetable\" id=\"auctionTable\">"+
			"<tr><th>Name</th><th>Price</th><th>Action</th></tr>"+
			tbstringactive+
			"</table>"+
		"</p>"
		;
	}
	if (msg.ClaimAuctionResponseP != null)
	{
		var slot = msg.ClaimAuctionResponseP.slot
		
	}
}

function refreshTrader() {
		var loginproto = new ProtoC.LoginProto();
		loginproto.CharCurrencyP = new ProtoC.CharCurrency();
		var buffer = loginproto.encode();
		socket.send(buffer.toArrayBuffer());
}

function sellButtonPressed (serial) {

	var price = $("#inputPrice_"+serial).val();

	var loginproto = new ProtoC.LoginProto();
	loginproto.CreateAuctionP = new ProtoC.CreateAuction();
	loginproto.CreateAuctionP.ItemSerial = serial;
	loginproto.CreateAuctionP.Gold = price;
	loginproto.CreateAuctionP.AGold = price;
	var buffer = loginproto.encode();
	socket.send(buffer.toArrayBuffer());
}

function buyButtonPressed (serial) {

	var price = $("#inputPrice_"+serial).val();

	var loginproto = new ProtoC.LoginProto();
	loginproto.BuyAuctionP = new ProtoC.BuyAuction();
	loginproto.BuyAuctionP.ItemSerial = serial;
	loginproto.BuyAuctionP.useagold = false;
	var buffer = loginproto.encode();
	socket.send(buffer.toArrayBuffer());
}

function claimButtonPressed (serial) {

	var price = $("#inputPrice_"+serial).val();

	var loginproto = new ProtoC.LoginProto();
	loginproto.ClaimAuctionP = new ProtoC.ClaimAuction();
	loginproto.ClaimAuctionP.Serial = serial;
	var buffer = loginproto.encode();
	socket.send(buffer.toArrayBuffer());
}

$.fn.digits = function(){ 
    return this.each(function(){ 
        $(this).text( $(this).text().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,") ); 
    })
}

var userN;
function LoginSubmit() {
    var user = document.getElementById('username').value.toUpperCase();
	var pass = document.getElementById('password').value;
//	var shapass = CryptoJS.SHA256(user+pass);
	var login = new ProtoC.LoginProto();
	login.LoginP = new ProtoC.Login(user, pass);
	userN = user;
	var buffer = login.encode();
	socket.send(buffer.toArrayBuffer());
}

	  document.getElementById('submitLogin').addEventListener('click', LoginSubmit, false);

	  connectWebsocket();
</script>
	  
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="assets/js/jquery.js"></script>
    <script src="assets/js/bootstrap-transition.js"></script>
    <script src="assets/js/bootstrap-alert.js"></script>
    <script src="assets/js/bootstrap-modal.js"></script>
    <script src="assets/js/bootstrap-dropdown.js"></script>
    <script src="assets/js/bootstrap-scrollspy.js"></script>
    <script src="assets/js/bootstrap-tab.js"></script>
    <script src="assets/js/bootstrap-tooltip.js"></script>
    <script src="assets/js/bootstrap-popover.js"></script>
    <script src="assets/js/bootstrap-button.js"></script>
    <script src="assets/js/bootstrap-collapse.js"></script>
    <script src="assets/js/bootstrap-carousel.js"></script>
    <script src="assets/js/bootstrap-typeahead.js"></script>

  </body>
</html>
